{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card p-4 p-md-5">
            <div class="text-center mb-4">
                <i class="fas fa-database fa-3x mb-3" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                <h2 class="mb-2">Ingestão de Dados</h2>
                <p class="text-muted">Baixe dados históricos do Yahoo Finance para treinar modelos</p>
            </div>

            <form id="ingest-form">
                <div class="mb-4">
                    <label for="ticker" class="form-label">
                        <i class="fas fa-tag me-1"></i>Ticker da Ação
                    </label>
                    <input type="text" class="form-control form-control-lg" id="ticker" placeholder="Ex: PETR4.SA, AAPL, MSFT, DIS" required>
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>Use o símbolo do Yahoo Finance (BR: .SA, EUA: sem sufixo)
                    </div>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label for="start_date" class="form-label">
                            <i class="fas fa-calendar-alt me-1"></i>Data Inicial
                        </label>
                        <input type="date" class="form-control" id="start_date">
                        <div class="form-text">Opcional - padrão: 1 ano atrás</div>
                    </div>
                    <div class="col-md-6">
                        <label for="end_date" class="form-label">
                            <i class="fas fa-calendar-check me-1"></i>Data Final
                        </label>
                        <input type="date" class="form-control" id="end_date">
                        <div class="form-text">Opcional - padrão: hoje</div>
                    </div>
                </div>

                <button type="submit" class="btn btn-info btn-lg w-100 text-white" id="btn-submit">
                    <span id="spinner" class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                    <i class="fas fa-download me-2" id="btn-icon"></i>
                    <span id="btn-text">Baixar Dados</span>
                </button>
            </form>

            <div id="result" class="mt-4 d-none"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('ingest-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const ticker = document.getElementById('ticker').value.toUpperCase();
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const btn = document.getElementById('btn-submit');
        const spinner = document.getElementById('spinner');
        const btnIcon = document.getElementById('btn-icon');
        const btnText = document.getElementById('btn-text');
        const resultDiv = document.getElementById('result');

        // Reset UI
        btn.disabled = true;
        spinner.classList.remove('d-none');
        btnIcon.classList.add('d-none');
        btnText.textContent = 'Baixando...';
        resultDiv.classList.add('d-none');

        try {
            let url = `/api/v1/ingest/${ticker}`;
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            if ([...params].length > 0) url += `?${params.toString()}`;

            const response = await axios.post(url);

            resultDiv.className = 'mt-4 alert alert-success';
            resultDiv.innerHTML = `
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-check-circle fa-2x me-3"></i>
                    <div>
                        <h4 class="alert-heading mb-1">Dados Baixados!</h4>
                        <p class="mb-0">${response.data.message}</p>
                    </div>
                </div>
                <hr>
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-database me-1"></i>Registros inseridos:</span>
                    <span class="badge bg-success fs-6">${response.data.records_inserted}</span>
                </div>
            `;
            resultDiv.classList.remove('d-none');

        } catch (error) {
            console.error(error);
            resultDiv.className = 'mt-4 alert alert-danger';
            const msg = error.response?.data?.detail || error.message;
            resultDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                    <div>
                        <h5 class="mb-1">Erro na Ingestão</h5>
                        <p class="mb-0">${msg}</p>
                    </div>
                </div>
            `;
            resultDiv.classList.remove('d-none');
        } finally {
            btn.disabled = false;
            spinner.classList.add('d-none');
            btnIcon.classList.remove('d-none');
            btnText.textContent = 'Baixar Dados';
        }
    });
</script>
{% endblock %}